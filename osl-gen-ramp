#!/usr/bin/python3
#+
# This script generates an Open Shading Language shader that does a
# piecewise-linear mapping of an input scalar to an output scalar.
# Invoke this script as follows:
#
#     osl-gen-ramp --name=«name» --segments=«segments»
#
# where «name» is the name to give to the shader, and «segments» is 1 less
# than the integer number of input/output value pairs that will be
# specified--this must be at least 1.
#
# Copyright 2017 by Lawrence D'Oliveiro <ldo@geek-central.gen.nz>.
# Licensed under CC-BY <http://creativecommons.org/licenses/by/4.0/>.
#-

import sys
import getopt

opts, args = getopt.getopt \
  (
    sys.argv[1:],
    "",
    ["name=", "segments="]
  )
nr_segs = None
shader_name = None
op_type = None
for keyword, value in opts :
    if keyword == "--segments" :
        nr_segs = int(value)
        assert nr_segs > 0
    elif keyword == "--name" :
        shader_name = value
    #end if
#end for
if nr_segs == None or shader_name == None :
    raise getopt.GetoptError("missing --name or --segments value")
#end if

sys.stdout.write \
  (
        "shader %(name)s\n"
        "  (\n"
        "    float In = 0.0,\n"
        "    output float Out = 0.0"
        "%(args)s\n"
        "  )\n"
        " /* generated by osl-gen-ramp. */\n"
        "  {\n"
        "    if (In < In0)\n"
        "        Out = Out0;\n"
        "%(body)s"
        "    else\n"
        "        Out = Out%(nr_segs)d;\n"
        "  } /*%(name)s*/\n"
    %
        {
            "name" : shader_name,
            "args" :
                "".join
                  (
                        ",\n"
                        "    float In%(i)d = %(default).3f,%(incond)s\n"
                        "    float Out%(i)d = %(default).3f"
                    %
                        {
                            "i" : i,
                            "incond" :
                                (
                                    lambda : "",
                                    lambda : " /* must be ≤ In%d */" % (i + 1),
                                )[i < nr_segs](),
                            "default" : i / nr_segs,
                        }
                    for i in range(nr_segs + 1)
                  ),
            "nr_segs" : nr_segs,
            "body" :
                "".join
                  (
                    "    else if (In < In%(j)d)\n"
                    "        Out = Out%(i)d + (Out%(j)d - Out%(i)d) * (In - In%(i)d) / (In%(j)d - In%(i)d);\n"
                    %
                        {
                            "i" : i,
                            "j" : i + 1,
                        }
                    for i in range(nr_segs)
                  ),
        }
  )
